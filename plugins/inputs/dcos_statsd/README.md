# DC/OS Statsd Plugin

The DC/OS statsd plugin gathers metrics from applications running as mesos tasks. Tasks with appropriate labels are
instrumented for metrics. 

Service discovery is achieved via a combination of task labels and port labels. Full examples are shown below for each
available format. 

### Statsd

Statsd, being a push format, requires only a task label. 

Each task instrumented for statsd has a dedicated statsd server process. The address of the server is injected into the
container via the standard `STATSD_UDP_HOST` and `STATSD_UDP_PORT` environment variables. 

The metrics received on this server are annotated with the task name and retransmitted to the
[statsd plugin](../statsd). 

Sample marathon app configuration:

```
{
  id: "statsd-emitter",
  cmd: "/opt/mesosphere/bin/statsd-emitter",
  labels: {
    DCOS_METRICS_TYPE: "statsd"
  }
}
```

### Prometheus

Prometheus, being a pull format, requires a label on every port on which a metrics endpoint can be found. 

The address of the port is resolved and passed to the [prometheus plugin](../prometheus), which handles collection.

Sample marathon app configuration:

```
{
  id: "prometheus-producer",
  cmd: "/opt/mesosphere/bin/prom-producer",
  labels: {
    DCOS_METRICS_TYPE: "prometheus"
  }
  ports: [
    {
      hostPort: 0,
      containerPort: 8080
      labels: {
        DCOS_METRICS_PORT: true
      }
    }
  ]
}
```

### Configuration:

This section contains the default TOML to configure the plugin.  You can
generate it using `telegraf --usage dcos_statsd`.

```toml
# Telegraf plugin for gathering metrics from mesos tasks
[[inputs.dcos_statsd]]
  ## The address of the mesos agent
  agent_address = "http://localhost:5051"

  ## Optional TLS Config
  # tls_ca = "/etc/telegraf/ca.pem"
  # tls_cert = "/etc/telegraf/cert.pem"
  # tls_key = "/etc/telegraf/key.pem"
  ## Use TLS but skip chain & host verification
  # insecure_skip_verify = false
```

With minimal configuration, this plugin expects the cluster to be in permissive
mode. Strict mode requires TLS configuration. 

### Metrics:

This plugin is a special case in that it relays metrics to other input plugins. It is additionally not possible to list
these metrics exhaustively, as they are generated by userland code. However, a counter is kept for tasks instrumented
with statsd which tracks how many metrics have passed through the plugin.

 - dcos_meta
   - fields:
     - metrics_count

### Tags:

All metrics have the following tags:

 - task_name
 - framework_name

### Example Output:

<!-- TODO: expand with all metrics -->
```
$ telegraf --config dcos.conf --input-filter dcos_container --test
* Plugin: dcos_workload
    dcos_meta,host=172.17.8.102,task_name=nginx,framework_name=marathon metrics_count=10 1453831884664956455
```
